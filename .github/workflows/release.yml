# MIT License (MIT)

# Copyright (c) 2025 Ronan Le Meillat for SCTG Development

# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:

# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.

# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
# THE SOFTWARE.
name: Cross-platform Release

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

jobs:
  build:
    name: Build ${{ matrix.target }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            artifact: tokei_rs-linux-x86_64.tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: tokei_rs-windows-x86_64.zip
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: tokei_rs-macos-x86_64.tar.gz
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: tokei_rs-macos-arm64.tar.gz

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Add rust target
        run: |
          rustup target add ${{ matrix.target }} || true

      - name: Setup environment for musl
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: |
          sudo apt-get update
          sudo apt-get -y install musl-tools pkg-config libssl-dev zip

      - name: Setup environment for Windows OpenSSL build
        if: matrix.target == 'x86_64-pc-windows-msvc'
        shell: pwsh
        run: |
          Write-Host "Installing StrawberryPerl & nasm for OpenSSL build"
          choco install strawberryperl -y
          choco install nasm -y
          choco install openssl.light -y || choco install openssl -y
          refreshenv
          # Install Perl modules required by OpenSSL Configure script
          cpan -i Locale::Maketext::Simple
          cpan -i IPC::Cmd
          cpan -i Params::Check
          cpan -i Text::Template

      - name: Patch Cargo.toml to disable vendored OpenSSL for Windows
        if: matrix.target == 'x86_64-pc-windows-msvc'
        shell: pwsh
        run: |
          Write-Host "Patching Cargo.toml to remove openssl vendored feature for windows"
          $content = Get-Content Cargo.toml -Raw
          $new = $content -replace 'openssl = \{ version = "0.10", features = \["vendored"\] \}', 'openssl = { version = "0.10" }'
          if ($content -eq $new) {
            Write-Host "No change to Cargo.toml; pattern not found"
          } else {
            $new | Set-Content Cargo.toml -Force
            Write-Host "Cargo.toml patched"
            Get-Content Cargo.toml | Select-String "openssl" | ForEach-Object { Write-Host $_ }
          }

      - name: Install OpenSSL runtime/devel on Windows
        if: matrix.target == 'x86_64-pc-windows-msvc'
        shell: pwsh
        run: |
          Write-Host "Installing OpenSSL via Chocolatey"
          choco install openssl.light -y || choco install openssl -y
          refreshenv

      - name: Detect OpenSSL and set environment variables for cargo
        if: matrix.target == 'x86_64-pc-windows-msvc'
        shell: pwsh
        run: |
          Write-Host "Detecting installed OpenSSL and setting OPENSSL_DIR env"
          $openssl = Get-Command openssl.exe -ErrorAction SilentlyContinue
          if ($null -ne $openssl) {
            $bin = Split-Path $openssl.Path -Parent
            $root = Split-Path $bin -Parent
            Write-Host "OpenSSL root: $root"
            Add-Content -Path $env:GITHUB_ENV -Value "OPENSSL_DIR=$root"
            Add-Content -Path $env:GITHUB_ENV -Value "OPENSSL_LIB_DIR=$root\lib"
            Add-Content -Path $env:GITHUB_ENV -Value "OPENSSL_INCLUDE_DIR=$root\include"
          } else {
            Write-Host "OpenSSL executable not found; cargo may still succeed if OPENSSL_DIR is set manually"
          }

      - name: Build
        env:
          CARGO_TERM_COLOR: always
        run: |
          echo "Building target: ${{ matrix.target }}"
          # Use target-specific build command
          if [[ "${{ matrix.target }}" == "x86_64-unknown-linux-musl" ]]; then
            export CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_LINKER=musl-gcc
            cargo build --release --target ${{ matrix.target }}
          elif [[ "${{ matrix.target }}" == "x86_64-pc-windows-msvc" ]]; then
            # Windows (native on windows-latest)
            cargo build --release --target ${{ matrix.target }}
          else
            # macOS builds (native on macOS runner)
            cargo build --release
          fi
        shell: bash

      - name: Prepare artifact (POSIX)
        if: ${{ runner.os != 'Windows' }}
        run: |
          mkdir -p artifacts
          if [ "${{ matrix.target }}" = "x86_64-unknown-linux-musl" ]; then
              cp target/${{ matrix.target }}/release/tokei_rs artifacts/tokei_rs
              tar -czf artifacts/${{ matrix.artifact }} -C artifacts tokei_rs
          else
              # macOS or other POSIX builds
              cp target/release/tokei_rs artifacts/tokei_rs
              tar -czf artifacts/${{ matrix.artifact }} -C artifacts tokei_rs
          fi
        shell: bash

      - name: Prepare artifact (Windows)
        if: ${{ runner.os == 'Windows' }}
        shell: pwsh
        run: |
          New-Item -Path artifacts -ItemType Directory -Force | Out-Null
          Copy-Item -Path "target\${{ matrix.target }}\release\tokei_rs.exe" -Destination "artifacts\tokei_rs.exe" -Force
          Compress-Archive -Path "artifacts\tokei_rs.exe" -DestinationPath "artifacts\${{ matrix.artifact }}" -Force
          if (-Not (Test-Path "artifacts\${{ matrix.artifact }}")) { Write-Error "Artifact missing after packaging: artifacts\${{ matrix.artifact }}" ; exit 1 }

      - name: List artifacts (build job) - POSIX
        if: ${{ runner.os != 'Windows' }}
        run: |
          echo "Listing artifacts after packaging"
          ls -laR artifacts || true
          test -f artifacts/${{ matrix.artifact }} || (echo "Artifact missing: artifacts/${{ matrix.artifact }}" && exit 1)
        shell: bash

      - name: List artifacts (build job) - Windows
        if: ${{ runner.os == 'Windows' }}
        shell: powershell
        run: |
          Write-Host "Listing artifacts after packaging"
          Get-ChildItem -Recurse -Force artifacts
          if (-Not (Test-Path "artifacts/${{ matrix.artifact }}")) { Write-Error "Artifact missing: artifacts/${{ matrix.artifact }}" ; exit 1 }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: artifacts/${{ matrix.artifact }}

  release:
    name: Create GitHub release with artifacts
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: ls -laR artifacts || true

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: "artifacts/**/*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
